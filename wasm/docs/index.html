
  <!DOCTYPE html>
  <html>
    <head>
      <title>wasm-opencc开放中文转换wasm版本，可在浏览器中直接运行。</title>
      <meta charset="utf-8" />
      <link rel="stylesheet" href="./codemirror.css" />
    </head>
    <body>
      <div id="main"><div data-reactroot=""><h1 style="color:#333;font-size:24px">wasm-opencc开放中文转换<!-- -->（<a href="https://github.com/BYVoid/OpenCC">OpenCC</a>）<!-- -->wasm版本</h1><div><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">香港繁體（香港小學學習字詞表標準）到簡體</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">簡體到香港繁體（香港小學學習字詞表標準）</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:#FFF;background:#40a9ff">簡體到繁體</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">簡體到臺灣正體</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">簡體到繁體（臺灣正體標準）並轉換爲臺灣常用詞彙</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">繁體（OpenCC 標準）到香港繁體（香港小學學習字詞表標準）</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">繁體到簡體</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">繁體（OpenCC 標準）到臺灣正體</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">臺灣正體到簡體</button><button style="cursor:pointer;margin:0 6px 10px 0;padding:0 10px;font-size:14px;height:34px;border-radius:4px;line-height:1.5;font-weight:400;text-align:center;border-color:#d9d9d9;color:rgba(0, 0, 0, 0.65);background:white">繁體（臺灣正體標準）到簡體並轉換爲中國大陸常用詞彙</button></div><div><div style="width:50%;display:inline-block"><div style="font-size:14px;border:1px solid #eee;border-radius:4px"></div></div><div style="width:50%;display:inline-block;vertical-align:top;box-sizing:border-box;padding:10px;font-size:14px"><div></div></div></div><div style="width:800px;margin:0 auto"><div><h1><a href="https://github.com/oyyd/wasm-opencc">wasm-opencc</a></h1><p><a href="https://www.npmjs.com/package/wasm-opencc"><img alt="npm-version" src="https://img.shields.io/npm/v/wasm-opencc.svg?style=flat-square"/></a>
<a href="https://travis-ci.com/oyyd/wasm-opencc#"><img alt="travis-ribbon" src="https://travis-ci.com/oyyd/wasm-opencc.svg?branch=master"/></a></p><p>wasm-opencc开放中文转换<a href="https://github.com/BYVoid/OpenCC">OpenCC</a>的wasm版本。</p><p>这个项目对OpenCC进行了添加修改修改，并利用<a href="https://github.com/kripken/emscripten">Emscripten</a>进行编译，在OpenCC进行中文简繁体转换的能力上具有以下特性：</p><ul><li>可在浏览器环境中直接运行。（wasm）</li><li>在node，eletron中运行不需要再进行addon编译，避免复杂的addon部署工作。理论上应该也可以在React Native和Web Worker中运行(未经测试)。（wasm）</li><li>分离了字典数据的加载和文本转换功能，在浏览器中只加载必要的字典数据，并允许自定义数据加载方式，方便从CDN上加载数据。</li></ul><h2>安装</h2><p>对于浏览器环境，请直接拷贝dist文件夹中的文件并在浏览器中加载，<strong>注意请一并拷贝dist文件夹下的.mem文件</strong>，该.mem文件为代码运行的必要文件。</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code><span style="color:#1f7199">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span style="font-weight:bold">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span style="font-weight:bold">head</span>&gt;</span><span class="hljs-tag">&lt;/<span style="font-weight:bold">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span style="font-weight:bold">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span style="font-weight:bold">script</span> <span class="hljs-attr">src</span>=<span style="color:#880000">&quot;./opencc-asm.js&quot;</span>&gt;</span><span class="null"></span><span class="hljs-tag">&lt;/<span style="font-weight:bold">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span style="font-weight:bold">script</span>&gt;</span><span class="javascript">
      <span style="font-weight:bold">const</span> { DictSource, Converter } = OpenCCWasm_
      OpenCCWasm_.ready().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span style="color:#888888">// 获取s2t.json字典数据</span>
        <span style="font-weight:bold">const</span> dictSource = <span style="font-weight:bold">new</span> DictSource(<span style="color:#880000">&#x27;s2t.json&#x27;</span>);
        <span style="font-weight:bold">return</span> dictSource.get();
      }).then(<span class="hljs-function">(<span class="hljs-params">args</span>) =&gt;</span> {
        <span style="font-weight:bold">const</span> converter = <span style="font-weight:bold">new</span> Converter(...args)
        <span style="color:#397300">console</span>.log(converter.convert(<span style="color:#880000">&#x27;繁体&#x27;</span>))
        <span style="color:#888888">// 注意当不再需要使用converter时，请调用delete方法以释放内存</span>
        converter.delete()
      })
    </span><span class="hljs-tag">&lt;/<span style="font-weight:bold">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span style="font-weight:bold">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span style="font-weight:bold">html</span>&gt;</span></code></pre><p>相关文件大小（不包含字典文件）：</p><ul><li>opencc-asm.js (655kB, gzip后164kB)</li><li>opencc-asm.js.mem (25kB, gzip后8kB)</li></ul><p>当前项目中的wasm代码，实际上是asmjs版本，并非用于浏览器原生WebAssembly的版本。asmjs的版本兼容性更好，WebAssembly版本体积更小（约在在250kB左右）。</p><p>对于node环境，可以直接利用npm安装:</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code><span style="color:#1f7199">$</span><span class="bash"> npm i -d wasm-opencc</span></code></pre><p>安装后加载使用：</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code><span style="font-weight:bold">const</span> { DictSource, Converter } = <span style="color:#397300">require</span>(<span style="color:#880000">&#x27;wasm-opencc&#x27;</span>)
<span style="font-weight:bold">const</span> dictSource = <span style="font-weight:bold">new</span> DictSource(<span style="color:#880000">&#x27;s2t.json&#x27;</span>);

dictSource.get().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span style="font-weight:bold">const</span> converter = <span style="font-weight:bold">new</span> Converter(...args)
  <span style="color:#397300">console</span>.log(converter.convert(<span style="color:#880000">&#x27;繁体&#x27;</span>))
  <span style="color:#888888">// 注意当不再需要使用converter时，请调用delete方法以释放内存</span>
  converter.delete()
})</code></pre><p>注意OpenCC本身具有<a href="https://www.npmjs.com/package/opencc">Node Addon版本</a>，请根据自己的需要选择。</p><h2>API</h2><h3>ready()</h3><p>在浏览器上，请先调用ready函数，并在结束后再进行<code>Converter</code>的相关操作。在Node上不需要等待ready函数结束，直接使用即可。</p><h3>class DictSource</h3><h4>new DictSource(string dictName)</h4><p><code>DictSource</code>用于获取字典数据，以初始化<code>Converter</code>。如果你熟悉OpenCC中Converter所需要的数据格式，和数据构成结构，你也可以完全避开<code>DictSource</code>，直接把字典数据的字符串传递给Converter。</p><p><code>dictName</code>所接受的参数请参照：<a href="https://github.com/BYVoid/OpenCC#configurations-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">預設配置文件</a></p><h4>DictSource.get()</h4><p><code>DictSource.get()</code>默认会根据运行环境不同，采用不同的方式获取数据。</p><p><code>DictSource.get()</code>返回一个Promise，这个Promise在resolve时会返回构建<code>Converter</code>所需要的参数的数组，当获取字典数据失败时会reject。返回参数的意义请参照<code>new Converter()</code>。</p><h4>DictSource.setDictProxy(function proxy)</h4><p>自定义获取数据的函数:</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code><span style="font-weight:bold">const</span> dictSource = <span style="font-weight:bold">new</span> DictSource(<span style="color:#880000">&#x27;s2t.json&#x27;</span>)

dictSource.setDictProxy(<span class="hljs-function">(<span class="hljs-params">dictName</span>) =&gt;</span> {
  <span style="color:#888888">// proxy需要返回一个promise</span>
  <span style="font-weight:bold">return</span> <span style="color:#397300">Promise</span>.resolve(<span style="color:#880000">&#x27;僞\t偽\n&#x27;</span>)
})

dictSource.get() <span style="color:#888888">// 会调用</span></code></pre><p>DictSource会给<code>proxy</code>函数传入所需要的字典名称，而<code>proxy</code>函数需要返回一个promise以告知DictSource请求结束或请求失败。成功的话需要resolve对应的字典数据内容，失败的话请reject一个<code>Error</code>对象。</p><h3>class Conveter</h3><h4>new Converter(string semgentation, Array&lt;Array<span>&lt;string&gt;</span>|string&gt; convertionChain)</h4><p><code>Converter</code>用来进行文本转换。</p><p>其中semgentation为分词用的数据；convertionChain按顺序定义了转换时所使用的一系列数据字典。</p><h4>Converter.convert(string text)</h4><p><code>Converter.convert</code>进行文本转换操作，同步操作。</p><h4>Converter.delete()</h4><p>销毁该实例在wasm中对应对象的实例。<strong>请注意：在不需要使用converter以后，一定要手动调用delete方法销毁内存。</strong></p><p>目前要求用户手动调用delete这点不可避免，这是Embind和目前wasm机制所决定的，可参照<a href="https://kripken.github.io/emscripten-site/docs/porting/connecting_cpp_and_javascript/embind.html#memory-management">Embind -- Memory Management</a>。</p><h2>已知问题</h2><ul><li>暂不接受<code>.ocd</code>类型的字典数据</li><li>uglifyjs相关问题：在开发过程中发现，用uglifyjs处理wasm编译的代码后，会导致其在Chrome上无法正常运行（但在safari上可以正常运行）。个人猜测是Chrome引发的问题。</li><li>因为上述原因，加之编译后代码本身的一些问题，作者对于在浏览器中运行的文件进行了一些自定义的处理并进行了bundle。如果你的项目要运行在浏览器环境上的话，不建议你对wasm-opencc自己进行bundle。</li></ul><h2>其他可能会实行的计划</h2><ul><li>进行Benchmark，探究Cpp版本，Node Addon版本和wasm版本之间的性能差距。</li><li>提供WebAssembly版本。</li><li>用closure进行编译提高效率。</li></ul><h2>Contribute</h2><p>请先安装Emscripten和OpenCC所需依赖，然后：</p><p>进行Emscripten编译代码：</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code><span style="font-weight:bold">make -f WasmMakefile</span></code></pre><p>构建js相关代码：</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code>cd wasm &amp;&amp; npm <span style="font-weight:bold">run</span><span class="bash"> build</span></code></pre><p>构建文档：</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code>cd wasm &amp;&amp; npm <span style="font-weight:bold">run</span><span class="bash"> docs</span></code></pre><p>运行测试：</p><pre style="display:block;overflow-x:auto;padding:0.5em;background:#F0F0F0;color:#444"><code>cd wasm &amp;&amp; npm <span style="font-weight:bold">run</span><span class="bash"> <span style="color:#397300">test</span></span></code></pre><h2>License</h2><p>这个项目在OpenCC的基础上添加了<code>/src/wasm</code>文件夹下的代码。原项目中多个文件夹下的CMakeLists.txt都被进行了一定程度上的修改。wasm相关的js代码主要放在<code>/wasm</code>文件夹下，为新增代码。<code>/docs</code>中的代码用于gh-pages展现文档。</p><p><a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache 2.0</a></p></div></div></div></div>
      <script src="./opencc-asm.js"></script>
      <script src="./index.js"></script>
    </body>
  </html>
  